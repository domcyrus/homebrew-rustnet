name: Update Homebrew Formula

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Get current formula version
        id: current
        run: |
          # Extract version from the first URL in the formula
          CURRENT_VERSION=$(grep -oE 'download/v[0-9]+\.[0-9]+\.[0-9]+/' Formula/rustnet.rb | head -1 | sed 's|download/v||; s|/||')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current formula version: v$CURRENT_VERSION"

      - name: Get latest release from rustnet repo
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_VERSION=$(gh api repos/domcyrus/rustnet/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest rustnet version: v$LATEST_VERSION"

      - name: Check if update is needed
        id: check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"

          if [ "$CURRENT" = "$LATEST" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Formula is already up to date (v$CURRENT)"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed: v$CURRENT -> v$LATEST"
          fi

      - name: Download binaries and calculate SHA256
        if: steps.check.outputs.needs_update == 'true'
        id: sha256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.latest.outputs.version }}"
          BASE_URL="https://github.com/domcyrus/rustnet/releases/download/v${VERSION}"

          echo "Downloading binaries for v${VERSION}..."

          # macOS ARM64
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-aarch64-apple-darwin.tar.gz" -o /tmp/macos-arm.tar.gz
          MACOS_ARM_SHA256=$(shasum -a 256 /tmp/macos-arm.tar.gz | awk '{print $1}')
          echo "macos_arm_sha256=$MACOS_ARM_SHA256" >> $GITHUB_OUTPUT
          echo "macOS ARM64: $MACOS_ARM_SHA256"

          # macOS Intel
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-x86_64-apple-darwin.tar.gz" -o /tmp/macos-intel.tar.gz
          MACOS_INTEL_SHA256=$(shasum -a 256 /tmp/macos-intel.tar.gz | awk '{print $1}')
          echo "macos_intel_sha256=$MACOS_INTEL_SHA256" >> $GITHUB_OUTPUT
          echo "macOS Intel: $MACOS_INTEL_SHA256"

          # Linux ARM64
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz" -o /tmp/linux-arm.tar.gz
          LINUX_ARM_SHA256=$(shasum -a 256 /tmp/linux-arm.tar.gz | awk '{print $1}')
          echo "linux_arm_sha256=$LINUX_ARM_SHA256" >> $GITHUB_OUTPUT
          echo "Linux ARM64: $LINUX_ARM_SHA256"

          # Linux Intel
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o /tmp/linux-intel.tar.gz
          LINUX_INTEL_SHA256=$(shasum -a 256 /tmp/linux-intel.tar.gz | awk '{print $1}')
          echo "linux_intel_sha256=$LINUX_INTEL_SHA256" >> $GITHUB_OUTPUT
          echo "Linux Intel: $LINUX_INTEL_SHA256"

          # Clean up
          rm /tmp/*.tar.gz

      - name: Update formula
        if: steps.check.outputs.needs_update == 'true'
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          NEW_VERSION="${{ steps.latest.outputs.version }}"
          MACOS_ARM_SHA256="${{ steps.sha256.outputs.macos_arm_sha256 }}"
          MACOS_INTEL_SHA256="${{ steps.sha256.outputs.macos_intel_sha256 }}"
          LINUX_ARM_SHA256="${{ steps.sha256.outputs.linux_arm_sha256 }}"
          LINUX_INTEL_SHA256="${{ steps.sha256.outputs.linux_intel_sha256 }}"
          FORMULA_FILE="Formula/rustnet.rb"

          echo "Updating formula with:"
          echo "  Version: v$CURRENT_VERSION -> v$NEW_VERSION"
          echo "  macOS ARM64 SHA256: $MACOS_ARM_SHA256"
          echo "  macOS Intel SHA256: $MACOS_INTEL_SHA256"
          echo "  Linux ARM64 SHA256: $LINUX_ARM_SHA256"
          echo "  Linux Intel SHA256: $LINUX_INTEL_SHA256"

          # Update all version occurrences in URLs (v0.16.1 -> vNEW_VERSION)
          sed -i '' "s|/v${CURRENT_VERSION}/rustnet-v${CURRENT_VERSION}-|/v${NEW_VERSION}/rustnet-v${NEW_VERSION}-|g" "$FORMULA_FILE"

          # Update SHA256 hashes (in order they appear in the file)
          # macOS ARM64 is first
          sed -i '' "0,/sha256 \"[a-f0-9]\{64\}\"/s//sha256 \"${MACOS_ARM_SHA256}\"/" "$FORMULA_FILE"
          # macOS Intel is second
          sed -i '' "0,/sha256 \"[a-f0-9]\{64\}\"/s//sha256 \"${MACOS_INTEL_SHA256}\"/" "$FORMULA_FILE"
          # Linux ARM64 is third
          sed -i '' "0,/sha256 \"[a-f0-9]\{64\}\"/s//sha256 \"${LINUX_ARM_SHA256}\"/" "$FORMULA_FILE"
          # Linux Intel is fourth
          sed -i '' "0,/sha256 \"[a-f0-9]\{64\}\"/s//sha256 \"${LINUX_INTEL_SHA256}\"/" "$FORMULA_FILE"

          echo "Formula updated successfully"
          echo ""
          echo "Changes:"
          git diff "$FORMULA_FILE"

      - name: Create temporary tap for validation
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Create a temporary local tap for validation
          brew tap-new temp/rustnet --no-git

          # Copy the updated formula to the temp tap
          cp Formula/rustnet.rb "$(brew --repository)/Library/Taps/temp/homebrew-rustnet/Formula/"

      - name: Validate formula with brew audit
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "Running brew audit on updated formula..."
          brew audit --strict --online --formula temp/rustnet/rustnet

      - name: Clean up temporary tap
        if: always() && steps.check.outputs.needs_update == 'true'
        run: |
          brew untap temp/rustnet || true

      - name: Commit and push changes
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.latest.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/rustnet.rb
          git commit -m "Update Rustnet to version v${VERSION}"
          git push

      - name: Create summary
        if: always()
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"
          NEEDS_UPDATE="${{ steps.check.outputs.needs_update }}"

          echo "### Homebrew Formula Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version:** v$CURRENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version:** v$LATEST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$NEEDS_UPDATE" = "true" ]; then
            MACOS_ARM="${{ steps.sha256.outputs.macos_arm_sha256 }}"
            MACOS_INTEL="${{ steps.sha256.outputs.macos_intel_sha256 }}"
            LINUX_ARM="${{ steps.sha256.outputs.linux_arm_sha256 }}"
            LINUX_INTEL="${{ steps.sha256.outputs.linux_intel_sha256 }}"
            echo "**Formula Updated Successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **New Version:** v$LATEST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**SHA256 Checksums:**" >> $GITHUB_STEP_SUMMARY
            echo "- macOS ARM64: \`${MACOS_ARM}\`" >> $GITHUB_STEP_SUMMARY
            echo "- macOS Intel: \`${MACOS_INTEL}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Linux ARM64: \`${LINUX_ARM}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Linux Intel: \`${LINUX_INTEL}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Validation:**" >> $GITHUB_STEP_SUMMARY
            echo "- Formula syntax validated with \`brew audit --strict --online\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No Update Needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The formula is already at the latest version." >> $GITHUB_STEP_SUMMARY
          fi
