name: Update Homebrew Formula

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'RustNet version to update to (e.g., 0.18.0)'
        required: true
        type: string

jobs:
  check-and-update:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Get current formula version
        id: current
        run: |
          # Extract version from the first URL in the formula
          CURRENT_VERSION=$(grep -oE 'download/v[0-9]+\.[0-9]+\.[0-9]+/' Formula/rustnet.rb | head -1 | sed 's|download/v||; s|/||')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current formula version: v$CURRENT_VERSION"

      - name: Normalize version input
        id: version
        run: |
          # Strip 'v' prefix if provided (e.g., v0.18.0 -> 0.18.0)
          VERSION=$(echo "${{ inputs.version }}" | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Target version: v$VERSION"

      - name: Check if update is needed
        id: check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TARGET="${{ steps.version.outputs.version }}"

          if [ "$CURRENT" = "$TARGET" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Formula is already up to date (v$CURRENT)"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Update needed: v$CURRENT -> v$TARGET"
          fi

      - name: Download binaries and calculate SHA256
        if: steps.check.outputs.needs_update == 'true'
        id: sha256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/domcyrus/rustnet/releases/download/v${VERSION}"

          echo "Downloading binaries for v${VERSION}..."

          # macOS ARM64
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-aarch64-apple-darwin.tar.gz" -o /tmp/macos-arm.tar.gz
          MACOS_ARM_SHA256=$(shasum -a 256 /tmp/macos-arm.tar.gz | awk '{print $1}')
          echo "macos_arm_sha256=$MACOS_ARM_SHA256" >> $GITHUB_OUTPUT
          echo "macOS ARM64: $MACOS_ARM_SHA256"

          # macOS Intel
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-x86_64-apple-darwin.tar.gz" -o /tmp/macos-intel.tar.gz
          MACOS_INTEL_SHA256=$(shasum -a 256 /tmp/macos-intel.tar.gz | awk '{print $1}')
          echo "macos_intel_sha256=$MACOS_INTEL_SHA256" >> $GITHUB_OUTPUT
          echo "macOS Intel: $MACOS_INTEL_SHA256"

          # Linux ARM64
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-aarch64-unknown-linux-gnu.tar.gz" -o /tmp/linux-arm.tar.gz
          LINUX_ARM_SHA256=$(shasum -a 256 /tmp/linux-arm.tar.gz | awk '{print $1}')
          echo "linux_arm_sha256=$LINUX_ARM_SHA256" >> $GITHUB_OUTPUT
          echo "Linux ARM64: $LINUX_ARM_SHA256"

          # Linux Intel
          curl -sL "${BASE_URL}/rustnet-v${VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o /tmp/linux-intel.tar.gz
          LINUX_INTEL_SHA256=$(shasum -a 256 /tmp/linux-intel.tar.gz | awk '{print $1}')
          echo "linux_intel_sha256=$LINUX_INTEL_SHA256" >> $GITHUB_OUTPUT
          echo "Linux Intel: $LINUX_INTEL_SHA256"

          # Clean up
          rm /tmp/*.tar.gz

      - name: Update formula
        if: steps.check.outputs.needs_update == 'true'
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          NEW_VERSION="${{ steps.version.outputs.version }}"
          MACOS_ARM_SHA256="${{ steps.sha256.outputs.macos_arm_sha256 }}"
          MACOS_INTEL_SHA256="${{ steps.sha256.outputs.macos_intel_sha256 }}"
          LINUX_ARM_SHA256="${{ steps.sha256.outputs.linux_arm_sha256 }}"
          LINUX_INTEL_SHA256="${{ steps.sha256.outputs.linux_intel_sha256 }}"
          FORMULA_FILE="Formula/rustnet.rb"

          echo "Updating formula with:"
          echo "  Version: v$CURRENT_VERSION -> v$NEW_VERSION"
          echo "  macOS ARM64 SHA256: $MACOS_ARM_SHA256"
          echo "  macOS Intel SHA256: $MACOS_INTEL_SHA256"
          echo "  Linux ARM64 SHA256: $LINUX_ARM_SHA256"
          echo "  Linux Intel SHA256: $LINUX_INTEL_SHA256"

          # Use Ruby to update the formula (BSD sed doesn't support GNU sed's 0,/pattern/ syntax)
          ruby -e '
            checksums = {
              "aarch64-apple-darwin" => ENV["MACOS_ARM_SHA256"],
              "x86_64-apple-darwin" => ENV["MACOS_INTEL_SHA256"],
              "aarch64-unknown-linux-gnu" => ENV["LINUX_ARM_SHA256"],
              "x86_64-unknown-linux-gnu" => ENV["LINUX_INTEL_SHA256"]
            }
            old_version = ENV["CURRENT_VERSION"]
            new_version = ENV["NEW_VERSION"]
            formula_path = ENV["FORMULA_FILE"]

            content = File.read(formula_path)

            # Update version in URLs
            content.gsub!("/v#{old_version}/rustnet-v#{old_version}-", "/v#{new_version}/rustnet-v#{new_version}-")

            # Update SHA256 for each platform by finding url line and updating following sha256
            checksums.each do |platform, sha|
              content.gsub!(/(url\s+"[^"]*#{Regexp.escape(platform)}[^"]*"\s*\n\s*sha256\s+")[a-f0-9]{64}(")/) do
                "#{$1}#{sha}#{$2}"
              end
            end

            File.write(formula_path, content)
          '

          echo "Formula updated successfully"
          echo ""
          echo "Changes:"
          git diff "$FORMULA_FILE"

      - name: Create temporary tap for validation
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Create a temporary local tap for validation
          brew tap-new temp/rustnet --no-git

          # Copy the updated formula to the temp tap
          cp Formula/rustnet.rb "$(brew --repository)/Library/Taps/temp/homebrew-rustnet/Formula/"

      - name: Validate formula with brew audit
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "Running brew audit on updated formula..."
          brew audit --strict --online --formula temp/rustnet/rustnet

      - name: Clean up temporary tap
        if: always() && steps.check.outputs.needs_update == 'true'
        run: |
          brew untap temp/rustnet || true

      - name: Commit and push changes
        if: steps.check.outputs.needs_update == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/rustnet.rb
          git commit -m "Update Rustnet to version v${VERSION}"
          git push

      - name: Create summary
        if: always()
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.version.outputs.version }}"
          NEEDS_UPDATE="${{ steps.check.outputs.needs_update }}"

          echo "### Homebrew Formula Update Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version:** v$CURRENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version:** v$LATEST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$NEEDS_UPDATE" = "true" ]; then
            MACOS_ARM="${{ steps.sha256.outputs.macos_arm_sha256 }}"
            MACOS_INTEL="${{ steps.sha256.outputs.macos_intel_sha256 }}"
            LINUX_ARM="${{ steps.sha256.outputs.linux_arm_sha256 }}"
            LINUX_INTEL="${{ steps.sha256.outputs.linux_intel_sha256 }}"
            echo "**Formula Updated Successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **New Version:** v$LATEST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**SHA256 Checksums:**" >> $GITHUB_STEP_SUMMARY
            echo "- macOS ARM64: \`${MACOS_ARM}\`" >> $GITHUB_STEP_SUMMARY
            echo "- macOS Intel: \`${MACOS_INTEL}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Linux ARM64: \`${LINUX_ARM}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Linux Intel: \`${LINUX_INTEL}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Validation:**" >> $GITHUB_STEP_SUMMARY
            echo "- Formula syntax validated with \`brew audit --strict --online\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**No Update Needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The formula is already at the latest version." >> $GITHUB_STEP_SUMMARY
          fi
